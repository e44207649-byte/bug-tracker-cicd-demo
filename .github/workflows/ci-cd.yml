name: ğŸš€ CI/CD Pipeline - Bug Tracker Demo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}

jobs:
  # ==========================================
  # QUALITY ASSURANCE & TESTING
  # ==========================================
  quality:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ§¹ ESLint Check
        run: npm run lint
        
      - name: ğŸ§ª Unit Tests
        run: npm run test:coverage
        
      - name: ğŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          
      - name: ğŸ’¾ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

  # ==========================================
  # END-TO-END TESTING
  # ==========================================
  e2e-tests:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        
      - name: ğŸ­ Run Cypress E2E Tests
        uses: cypress-io/github-action@v6
        with:
          start: npm start
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120
          browser: chrome
          record: false
          
      - name: ğŸ“¸ Upload Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          
      - name: ğŸ“¹ Upload Videos
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos

  # ==========================================
  # BUILD APPLICATION
  # ==========================================
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [quality, e2e-tests]
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        
      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: |
            .next/
            package.json
            package-lock.json
          retention-days: 7

  # ==========================================
  # DEPLOY TO STAGING
  # ==========================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to Vercel (Staging)
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}
          
      - name: ğŸ¥ Health Check
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30
          echo "Testing deployment URL: ${{ steps.deploy.outputs.preview-url }}"
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy.outputs.preview-url }}")
          if [ $response -eq 200 ]; then
            echo "âœ… Staging deployment is healthy (HTTP 200)"
          elif [ $response -eq 401 ]; then
            echo "âœ… Staging deployment is healthy (HTTP 401 - Protected by Vercel auth)"
          else
            echo "âŒ Staging deployment failed health check (HTTP $response)"
            exit 1
          fi
          
      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Staging Deployment Ready!**
              
              ğŸ“± Preview URL: ${{ steps.deploy.outputs.preview-url }}
              
              âœ… All tests passed
              âœ… Build successful
              âœ… Deployment completed
              
              Ready for review! ğŸ‰`
            })

  # ==========================================
  # JIRA INTEGRATION - STAGING UPDATES
  # ==========================================
  update-jira-staging:
    name: ğŸ“ Update Jira (Staging)
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: contains(github.event.head_commit.message, 'DEMO-') || contains(github.event.pull_request.title, 'DEMO-')
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“ Extract Jira Issue Key
        id: jira-key
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            MESSAGE="${{ github.event.pull_request.title }}"
          else
            MESSAGE="${{ github.event.head_commit.message }}"
          fi
          ISSUE_KEY=$(echo "$MESSAGE" | grep -oP 'DEMO-\d+' | head -1)
          echo "issue-key=$ISSUE_KEY" >> $GITHUB_OUTPUT
          echo "Found Jira issue: $ISSUE_KEY"
          
      - name: ğŸ“ Add Staging Comment to Jira
        if: steps.jira-key.outputs.issue-key != ''
        continue-on-error: true
        run: |
          echo "Adding comment to Jira ticket: ${{ steps.jira-key.outputs.issue-key }}"
          
          # Normalize URL (remove trailing slash)
          JIRA_URL="${{ secrets.JIRA_BASE_URL }}"
          JIRA_URL=${JIRA_URL%/}  # Remove trailing slash if present
          
          # Create base64 auth header with no line breaks
          AUTH_HEADER=$(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64 -w 0)
          
          # Create properly formatted JSON for Jira comment
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "Authorization: Basic $AUTH_HEADER" \
            -d '{
              "body": "ğŸš€ *Staging Deployment Complete*\n\n*Environment:* Staging\n*Deployment URL:* ${{ needs.deploy-staging.outputs.preview-url || 'Available via Vercel dashboard' }}\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n\nâœ… All tests passed\nâœ… Quality checks passed\nâœ… Deployment successful\n\nReady for testing and review!"
            }' \
            "$JIRA_URL/rest/api/2/issue/${{ steps.jira-key.outputs.issue-key }}/comment" \
            -w "HTTP_STATUS:%{http_code}" \
            -o /tmp/jira_response.json
          
          # Check if the request was successful
          if grep -q "HTTP_STATUS:201" /tmp/jira_response.json 2>/dev/null; then
            echo "âœ… Successfully added comment to Jira ticket"
          else
            echo "âš ï¸ Jira comment may have failed - continuing anyway"
            cat /tmp/jira_response.json 2>/dev/null || echo "(no response file)"
          fi

  # ==========================================
  # DEPLOY TO PRODUCTION (MANUAL APPROVAL)
  # ==========================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://bug-tracker-cicd-demo.vercel.app
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸŒŸ Deploy to Vercel (Production)
        id: deploy-prod
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}
          
      - name: ğŸ¥ Production Health Check
        run: |
          echo "Waiting for production deployment to be ready..."
          sleep 45
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "https://bug-tracker-cicd-demo.vercel.app")
            if [ $response -eq 200 ]; then
              echo "âœ… Production deployment is healthy (attempt $i)"
              break
            else
              echo "â³ Health check attempt $i failed (HTTP $response), retrying..."
              sleep 15
            fi
            if [ $i -eq 5 ]; then
              echo "âŒ Production health check failed after 5 attempts"
              exit 1
            fi
          done
          
      - name: ğŸ‰ Production Deployment Success
        run: |
          echo "ğŸ‰ Production deployment successful!"
          echo "ğŸŒŸ URL: https://bug-tracker-cicd-demo.vercel.app"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"

  # ==========================================
  # JIRA INTEGRATION - PRODUCTION UPDATES
  # ==========================================
  update-jira-production:
    name: ğŸ“ Update Jira (Production)
    runs-on: ubuntu-latest
    needs: deploy-production
    if: contains(github.event.head_commit.message, 'DEMO-')
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“ Extract Jira Issue Key
        id: jira-key
        run: |
          MESSAGE="${{ github.event.head_commit.message }}"
          ISSUE_KEY=$(echo "$MESSAGE" | grep -oP 'DEMO-\d+' | head -1)
          echo "issue-key=$ISSUE_KEY" >> $GITHUB_OUTPUT
          echo "Found Jira issue: $ISSUE_KEY"
          
      - name: ğŸ“ Add Production Comment to Jira
        if: steps.jira-key.outputs.issue-key != ''
        continue-on-error: true
        run: |
          echo "Adding production comment to Jira ticket: ${{ steps.jira-key.outputs.issue-key }}"
          
          # Normalize URL (remove trailing slash)
          JIRA_URL="${{ secrets.JIRA_BASE_URL }}"
          JIRA_URL=${JIRA_URL%/}  # Remove trailing slash if present
          
          # Create base64 auth header with no line breaks
          AUTH_HEADER=$(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64 -w 0)
          
          # Create properly formatted JSON for Jira comment
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "Authorization: Basic $AUTH_HEADER" \
            -d '{
              "body": "ğŸŒŸ *Production Deployment Complete*\n\n*Environment:* Production\n*URL:* https://bug-tracker-cicd-demo.vercel.app\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Author:* ${{ github.actor }}\n*Deployed at:* '$(date -u '+%Y-%m-%d %H:%M:%S UTC')'\n\nâœ… All quality gates passed\nâœ… Staging tests successful\nâœ… Production deployment verified\nâœ… Health checks passed\n\nğŸ‰ Feature is now live in production!"
            }' \
            "$JIRA_URL/rest/api/2/issue/${{ steps.jira-key.outputs.issue-key }}/comment" \
            -w "HTTP_STATUS:%{http_code}" \
            -o /tmp/jira_prod_response.json
          
          # Check if the request was successful
          if grep -q "HTTP_STATUS:201" /tmp/jira_prod_response.json 2>/dev/null; then
            echo "âœ… Successfully added production comment to Jira ticket"
          else
            echo "âš ï¸ Jira comment may have failed - continuing anyway"
            cat /tmp/jira_prod_response.json 2>/dev/null || echo "(no response file)"
          fi
          
      - name: ğŸ¯ Transition Jira Issue to Done
        if: steps.jira-key.outputs.issue-key != ''
        continue-on-error: true
        run: |
          echo "Transitioning Jira ticket to Done: ${{ steps.jira-key.outputs.issue-key }}"
          
          # Normalize URL (remove trailing slash)
          JIRA_URL="${{ secrets.JIRA_BASE_URL }}"
          JIRA_URL=${JIRA_URL%/}  # Remove trailing slash if present
          
          # Create base64 auth header with no line breaks
          AUTH_HEADER=$(echo -n '${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64 -w 0)
          
          # First, get available transitions to find the correct transition ID
          echo "Getting available transitions..."
          curl -X GET \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "Authorization: Basic $AUTH_HEADER" \
            "$JIRA_URL/rest/api/2/issue/${{ steps.jira-key.outputs.issue-key }}/transitions" \
            -o /tmp/transitions.json
          
          # Try to transition to Done (this might fail if transition doesn't exist)
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "Authorization: Basic $AUTH_HEADER" \
            -d '{
              "transition": {
                "name": "Done"
              }
            }' \
            "$JIRA_URL/rest/api/2/issue/${{ steps.jira-key.outputs.issue-key }}/transitions" \
            -w "HTTP_STATUS:%{http_code}" \
            -o /tmp/jira_transition_response.json
          
          # Check if the request was successful
          if grep -q "HTTP_STATUS:204" /tmp/jira_transition_response.json 2>/dev/null; then
            echo "âœ… Successfully transitioned Jira ticket to Done"
          else
            echo "âš ï¸ Jira transition may have failed - this is normal if 'Done' transition doesn't exist"
            echo "Available transitions:"
            cat /tmp/transitions.json 2>/dev/null || echo "(could not get transitions)"
          fi
          
      - name: â„¹ï¸ Jira Integration Note
        if: steps.jira-key.outputs.issue-key != ''
        run: |
          echo "â„¹ï¸ Attempted to update Jira ticket: ${{ steps.jira-key.outputs.issue-key }}"
          echo "For demo purposes, ensure tickets like DEMO-123, DEMO-124 exist in Jira"
          echo "Pipeline will continue successfully even if Jira integration fails"

  # ==========================================
  # NOTIFICATIONS & REPORTING
  # ==========================================
  notify-success:
    name: ğŸ“¢ Success Notifications
    runs-on: ubuntu-latest
    needs: [deploy-production, update-jira-production]
    if: always() && needs.deploy-production.result == 'success'
    
    steps:
      - name: ğŸ“¢ Pipeline Success Notification
        run: |
          echo "ğŸ‰ ===== PIPELINE SUCCESS ===== ğŸ‰"
          echo ""
          echo "âœ… Quality checks passed"
          echo "âœ… All tests passed"
          echo "âœ… Build successful"
          echo "âœ… Staging deployment successful"
          echo "âœ… Production deployment successful"
          echo "âœ… Health checks passed"
          echo ""
          echo "ğŸŒŸ Production URL: https://bug-tracker-cicd-demo.vercel.app"
          echo "ğŸ§ª Staging URL: https://bug-tracker-demo-staging.vercel.app"
          echo ""
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ·ï¸ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo ""
          echo "ğŸš€ Deployment complete!"

  notify-failure:
    name: ğŸš¨ Failure Notifications
    runs-on: ubuntu-latest
    needs: [quality, e2e-tests, build, deploy-staging, deploy-production]
    if: always() && (needs.quality.result == 'failure' || needs.e2e-tests.result == 'failure' || needs.build.result == 'failure' || needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    
    steps:
      - name: ğŸš¨ Pipeline Failure Notification
        run: |
          echo "ğŸš¨ ===== PIPELINE FAILURE ===== ğŸš¨"
          echo ""
          echo "âŒ Pipeline failed at one or more stages:"
          echo "   - Quality checks: ${{ needs.quality.result }}"
          echo "   - E2E tests: ${{ needs.e2e-tests.result }}"
          echo "   - Build: ${{ needs.build.result }}"
          echo "   - Deploy staging: ${{ needs.deploy-staging.result }}"
          echo "   - Deploy production: ${{ needs.deploy-production.result }}"
          echo ""
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ·ï¸ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo ""
          echo "ğŸ” Check the logs above for details"